# 礼金簿展示区缩放显示问题修复计划

## 问题描述

当窗口放大时，若窗口长度超过默认比例的长度，礼金簿展示区右侧会出现空白画布。

## 根本原因分析

1. **当前缩放逻辑问题**：`useFullscreenScale.ts` 使用固定基准尺寸 1440x900，但实际内容尺寸更大
2. **主内容区未保持固定比例**：`main-content` 使用 `flex: 1` 导致宽度自适应变化
3. **缺少最小缩放限制**：未设置 70% 的最小缩放比例
4. **缺少居中对齐**：放大时未实现内容居中显示

## 修复方案

### 方案概述

采用**两层缩放**策略：
1. **外层缩放**：整个应用容器按比例缩放
2. **内层布局**：主内容区保持固定比例，不随窗口变化

---

## 实施步骤

### 第一步：调整 CSS 变量（theme.css）

**目标**：建立准确的基础尺寸参数

**修改位置**：`src/styles/theme.css`

```css
/* 
  ----------------------------------------
  礼金簿展示区基础尺寸参数
  ----------------------------------------
  - giftbook-base-width: 基础宽度 1290px（15列*80px + 两侧边距90px）
  - giftbook-base-height: 基础高度 741px
  - giftbook-padding-x: 水平边距 45px
  - giftbook-padding-y: 垂直边距 24px
  - giftbook-default-window-width: 默认窗口宽度 1444px
  - giftbook-default-window-height: 默认窗口高度 823px
  - app-min-scale: 最小缩放比例 0.7（70%）
*/
--giftbook-base-width: 1290px;
--giftbook-base-height: 741px;
--giftbook-padding-x: 45px;
--giftbook-padding-y: 24px;
--giftbook-default-window-width: 1444px;
--giftbook-default-window-height: 823px;
--app-min-scale: 0.7;
```

---

### 第二步：优化缩放逻辑（useFullscreenScale.ts）

**目标**：实现最小缩放限制和精确的缩放计算

**修改位置**：`src/composables/useFullscreenScale.ts`

```typescript
import { ref } from 'vue'

// 固定基准尺寸（设计稿尺寸）
const BASELINE_WIDTH = 1444
const BASELINE_HEIGHT = 823
const MIN_SCALE = 0.7
const MAX_SCALE = 3
const scale = ref(1)

/**
 * 计算缩放比例
 * 实现逻辑：
 * 1. 计算宽度和高度的缩放比例
 * 2. 取较小值确保内容完整显示
 * 3. 应用最小缩放限制（0.7倍）
 * 4. 应用最大缩放限制（3倍）
 */
function calculateScale(): number {
  const w = window.innerWidth
  const h = window.innerHeight

  const sx = w / BASELINE_WIDTH
  const sy = h / BASELINE_HEIGHT

  // 取较小值确保内容完整显示
  const candidate = Math.min(sx, sy)

  // 应用最小和最大缩放限制
  return Math.max(MIN_SCALE, Math.min(MAX_SCALE, candidate))
}

/**
 * 更新缩放比例并应用到 CSS 变量
 */
function updateScale(): void {
  const newScale = calculateScale()
  scale.value = newScale
  document.documentElement.style.setProperty('--fullscreen-scale', scale.value.toString())
}

/**
 * 获取当前缩放比例
 */
function getCurrentScale(): number {
  return scale.value
}

/**
 * 获取基准尺寸
 */
function getBaseline(): { width: number; height: number } {
  return {
    width: BASELINE_WIDTH,
    height: BASELINE_HEIGHT,
  }
}

/**
 * 初始化全屏缩放
 * 在应用启动时调用，设置初始缩放比例并监听窗口大小变化
 */
function initFullscreenScale(): void {
  updateScale()
  window.addEventListener('resize', updateScale)
}

/**
 * 销毁全屏缩放
 * 在应用卸载时调用，移除事件监听
 */
function destroyFullscreenScale(): void {
  window.removeEventListener('resize', updateScale)
}

export function useFullscreenScale() {
  return {
    scale,
    getCurrentScale,
    initFullscreenScale,
    destroyFullscreenScale,
    updateScale,
    getBaseline,
  }
}

export default useFullscreenScale
```

**关键改动**：
- 基准尺寸从 1440x900 改为 1444x823（实际默认窗口尺寸）
- 添加最小缩放限制 0.7（70%）
- 保持最大缩放限制 4 倍
- 允许缩小（低于 1 倍）

---

### 第三步：调整主内容区布局（App.vue）

**目标**：主内容区保持固定比例，居中显示

**修改位置**：`src/App.vue`

#### 3.1 调整 `.app-container` 样式

```css
.app-container {
  display: flex;
  flex-direction: column;
  background: var(--theme-primary);
  overflow: hidden;
  transform: scale(var(--fullscreen-scale));
  transform-origin: top left;
  /* 根据缩放比例反向计算容器尺寸 */
  width: calc(100vw / var(--fullscreen-scale));
  height: calc(100vh / var(--fullscreen-scale));
  min-width: calc(1444px * 0.7);  /* 最小宽度：基准宽度的70% */
  min-height: calc(823px * 0.7);  /* 最小高度：基准高度的70% */
}
```

#### 3.2 调整 `.main-content` 样式

```css
.main-content {
  flex: 1;
  display: flex;
  justify-content: center;  /* 水平居中 */
  align-items: flex-start;  /* 垂直顶部对齐 */
  gap: var(--theme-spacing-lg);          /* 24px */
  padding: var(--theme-spacing-lg);      /* 24px */
  overflow: hidden;
  
  /* 保持固定比例 */
  width: 1444px;  /* 基准宽度 */
  min-width: calc(1444px * 0.7);  /* 最小宽度：基准宽度的70% */
  max-width: 1444px;  /* 最大宽度：基准宽度 */
  height: 823px;  /* 基准高度 */
  min-height: calc(823px * 0.7);  /* 最小高度：基准高度的70% */
  max-height: 823px;  /* 最大高度：基准高度 */
}
```

#### 3.3 调整 `.giftbook-section` 样式

```css
.giftbook-section {
  width: 1290px;  /* 固定宽度：礼金簿基础宽度 */
  flex-shrink: 0; /* 不收缩 */
  overflow: hidden;
}
```

#### 3.4 调整 `.sidebar-section` 样式

```css
.sidebar-section {
  width: 208px;   /* 固定宽度 */
  flex-shrink: 0; /* 不收缩 */
  display: flex;
  flex-direction: column;
  gap: var(--theme-spacing-lg);          /* 面板间距 24px */
  overflow-y: auto;
}
```

---

### 第四步：优化 RecordList 组件（可选）

**目标**：确保礼金簿展示区在固定宽度下正常显示

**修改位置**：`src/components/RecordList.vue`

检查 `.giftbook-content` 和 `.records-grid` 的宽度设置：

```css
.giftbook-content {
  flex: 1;
  position: relative;
  overflow: hidden;
  padding: var(--theme-spacing-lg);  /* 24px */
  width: 100%;  /* 确保占满父容器宽度 */
  max-width: 1290px;  /* 最大宽度：礼金簿基础宽度 */
}

.records-grid {
  position: relative;
  height: 100%;
  display: flex;
  flex-direction: row;
  gap: 0;
  overflow-x: auto;
  overflow-y: hidden;
  padding: var(--theme-spacing-md);
  width: 100%;  /* 确保占满父容器宽度 */
  max-width: 1290px;  /* 最大宽度：礼金簿基础宽度 */
}
```

---

## 预期效果

### 缩放行为

1. **窗口缩小（< 70%）**：
   - 缩放比例锁定在 0.7 倍
   - 内容完整显示，不被裁剪
   - 出现滚动条（如果需要）

2. **窗口缩放（70% - 100%）**：
   - 缩放比例随窗口变化（0.7 - 1.0 倍）
   - 内容按比例缩小
   - 保持原始比例

3. **窗口放大（> 100%）**：
   - 缩放比例随窗口变化（1.0 - 3.0 倍）
   - 内容按比例放大
   - 保持原始比例
   - **居中显示**，无空白画布

4. **窗口远大于基准尺寸**：
   - 缩放比例锁定在 3.0 倍
   - 内容放大到最大
   - 保持居中显示

### 布局稳定性

1. **主内容区**：
   - 固定宽度 1444px
   - 固定高度 823px
   - 始终保持原始比例
   - 居中显示

2. **礼金簿展示区**：
   - 固定宽度 1290px
   - 高度自适应
   - 无空白画布

3. **边栏**：
   - 固定宽度 208px
   - 不随窗口变化
   - 保持稳定布局

---

## 测试验证

### 测试场景

1. **窗口尺寸测试**：
   - 600x400（小于最小尺寸）
   - 1024x768（小于基准尺寸）
   - 1444x823（基准尺寸）
   - 1920x1080（大于基准尺寸）
   - 2560x1440（远大于基准尺寸）
   - 3840x2160（4K分辨率）

2. **缩放比例验证**：
   - 窗口 600x400 → 缩放 0.7
   - 窗口 1024x768 → 缩放 0.7-1.0
   - 窗口 1444x823 → 缩放 1.0
   - 窗口 1920x1080 → 缩放 1.0-3.0
   - 窗口 3840x2160 → 缩放 3.0

3. **布局验证**：
   - 礼金簿展示区无空白画布
   - 主内容区保持固定比例
   - 内容居中显示
   - 边栏位置稳定

4. **交互验证**：
   - 滚动条正常工作
   - 点击事件正常响应
   - 动画效果正常播放

---

## 风险评估

### 潜在问题

1. **布局偏移**：
   - 原因：缩放原点设置不当
   - 解决：确保 `transform-origin: top left`

2. **内容裁剪**：
   - 原因：容器尺寸计算错误
   - 解决：使用 `calc(100vw / var(--fullscreen-scale))`

3. **滚动异常**：
   - 原因：overflow 设置不当
   - 解决：在合适层级设置 `overflow: auto`

### 回滚方案

如遇严重问题，可按以下步骤回滚：

1. 恢复 `useFullscreenScale.ts` 到原始版本
2. 恢复 `App.vue` 的 `.app-container` 和 `.main-content` 样式
3. 恢复 `RecordList.vue` 的相关样式

---

## 实施顺序

1. ✅ **第一步**：调整 CSS 变量（theme.css）
2. ✅ **第二步**：优化缩放逻辑（useFullscreenScale.ts）
3. ✅ **第三步**：调整主内容区布局（App.vue）
4. ✅ **第四步**：优化 RecordList 组件（可选）
5. ✅ **第五步**：测试验证

---

## 备注

- 所有尺寸单位均为 px
- 缩放比例计算使用 `Math.min(sx, sy)` 确保内容完整显示
- 最小缩放限制 0.7 确保内容可读性
- 最大缩放限制 3.0 避免过度放大导致模糊
- 居中显示通过 `justify-content: center` 实现
