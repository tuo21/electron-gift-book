# ä¿®æ”¹è®°å½•æŸ¥è¯¢ç•Œé¢å³é”®èœå•åŠŸèƒ½è®¡åˆ’

## éœ€æ±‚æ¦‚è¿°
åœ¨ä¿®æ”¹è®°å½•æŸ¥è¯¢ç•Œé¢ï¼ˆEditHistoryModalï¼‰ï¼Œç”¨æˆ·å¯ä»¥åœ¨è®°å½•ä¸Šå³é”®å¼¹å‡ºä¸¤ä¸ªèœå•é¡¹ï¼š
1. **"å®šä½åˆ°è¯¥é¡¹"** - é€€å‡ºæŸ¥è¯¢é¡µï¼Œè‡ªåŠ¨è·³è½¬åˆ°è¯¥é¡¹æ‰€åœ¨é¡µé¢ï¼Œå¹¶å¢åŠ é«˜äº®åŠ¨ç”»æç¤ºä½ç½®
2. **"è¿˜åŸä¿®æ”¹"** - å¼¹å‡ºç¡®è®¤æ¡†ï¼Œç¡®è®¤åå°†æ­¤é¡¹æ•°æ®æ”¹æˆä¿®æ”¹å‰çš„æ•°æ®ï¼Œè®°å½•æ­¤æ¬¡ä¿®æ”¹ï¼Œå¹¶è·³è½¬åˆ°è¯¥é¡¹æ‰€åœ¨é¡µ

## åŠŸèƒ½è®¾è®¡

### 1. å³é”®èœå•è®¾è®¡

#### UI è®¾è®¡
- å³é”®ç‚¹å‡»å†å²è®°å½•é¡¹æ—¶å¼¹å‡ºèœå•
- èœå•åŒ…å«ä¸¤ä¸ªé€‰é¡¹ï¼š
  - ğŸ“ å®šä½åˆ°è¯¥é¡¹
  - â†©ï¸ è¿˜åŸä¿®æ”¹
- èœå•æ ·å¼ä¸ä¸»é¢˜ä¸€è‡´

#### äº¤äº’é€»è¾‘
- å³é”®ç‚¹å‡»è®°å½•é¡¹æ—¶æ˜¾ç¤ºèœå•
- ç‚¹å‡»èœå•é¡¹æˆ–ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶å…³é—­èœå•
- èœå•ä½ç½®è·Ÿéšé¼ æ ‡ç‚¹å‡»ä½ç½®

### 2. "å®šä½åˆ°è¯¥é¡¹"åŠŸèƒ½

#### å®ç°é€»è¾‘
1. å…³é—­ä¿®æ”¹è®°å½•å¼¹çª—ï¼ˆemit 'close'ï¼‰
2. è°ƒç”¨ `findRecordPage` è·å–è®°å½•æ‰€åœ¨é¡µç 
3. è®¾ç½®å½“å‰é¡µç ä¸ºè®°å½•æ‰€åœ¨é¡µ
4. ç­‰å¾…é¡µé¢æ¸²æŸ“å®Œæˆåï¼Œé«˜äº®æ˜¾ç¤ºç›®æ ‡è®°å½•
5. æ·»åŠ é«˜äº®åŠ¨ç”»æ•ˆæœï¼ˆé—ªçƒæˆ–è¾¹æ¡†é«˜äº®ï¼‰

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
- `EditHistoryModal.vue` - æ·»åŠ å³é”®èœå•å’Œå®šä½åŠŸèƒ½
- `App.vue` - å¤„ç†å®šä½äº‹ä»¶ï¼Œè·³è½¬åˆ°æŒ‡å®šé¡µ
- `RecordList.vue` - æ·»åŠ é«˜äº®è®°å½•çš„åŠŸèƒ½

### 3. "è¿˜åŸä¿®æ”¹"åŠŸèƒ½

#### å®ç°é€»è¾‘
1. å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼š"ç¡®å®šè¦è¿˜åŸæ­¤ä¿®æ”¹å—ï¼Ÿ"
2. ç”¨æˆ·ç¡®è®¤åï¼š
   - è·å–ä¿®æ”¹å‰çš„æ•°æ®ï¼ˆhistory ä¸­çš„æ—§å€¼ï¼‰
   - è°ƒç”¨ `updateRecord` æ›´æ–°è®°å½•ä¸ºæ—§å€¼
   - è®°å½•æ­¤æ¬¡è¿˜åŸæ“ä½œåˆ°å†å²è®°å½•
   - å…³é—­ä¿®æ”¹è®°å½•å¼¹çª—
   - è·³è½¬åˆ°è¯¥é¡¹æ‰€åœ¨é¡µé¢
   - é«˜äº®æ˜¾ç¤ºè¯¥è®°å½•

#### æ•°æ®å‡†å¤‡
éœ€è¦è·å–çš„å†å²è®°å½•å­—æ®µï¼š
- `recordId` - è®°å½•ID
- `guestName` / `amount` / `itemDescription` / `paymentType` / `remark` - ä¿®æ”¹å‰çš„å€¼

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
- `EditHistoryModal.vue` - æ·»åŠ è¿˜åŸåŠŸèƒ½
- `useRecordsStore.ts` - æ·»åŠ  `revertRecord` action
- `App.vue` - å¤„ç†è¿˜åŸäº‹ä»¶

## è¯¦ç»†å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®æ”¹ EditHistoryModal.vue

#### 1.1 æ·»åŠ å³é”®èœå•æ¨¡æ¿
```vue
<!-- å³é”®èœå• -->
<div
  v-if="contextMenuVisible"
  class="context-menu"
  :style="{ left: contextMenuX + 'px', top: contextMenuY + 'px' }"
  @click.stop
>
  <div class="context-menu-item" @click="handleLocate">
    <span class="menu-icon">ğŸ“</span>
    <span>å®šä½åˆ°è¯¥é¡¹</span>
  </div>
  <div
    class="context-menu-item"
    :class="{ 'disabled': selectedHistory?.operationType === 'DELETE' }"
    @click="handleRevert"
  >
    <span class="menu-icon">â†©ï¸</span>
    <span>è¿˜åŸä¿®æ”¹</span>
  </div>
</div>
```

#### 1.2 æ·»åŠ å³é”®èœå•é€»è¾‘
```typescript
// å³é”®èœå•çŠ¶æ€
const contextMenuVisible = ref(false)
const contextMenuX = ref(0)
const contextMenuY = ref(0)
const selectedHistory = ref<RecordHistory | null>(null)

// æ˜¾ç¤ºå³é”®èœå•
const showContextMenu = (event: MouseEvent, history: RecordHistory) => {
  event.preventDefault()
  selectedHistory.value = history
  contextMenuX.value = event.clientX
  contextMenuY.value = event.clientY
  contextMenuVisible.value = true
}

// å…³é—­å³é”®èœå•
const closeContextMenu = () => {
  contextMenuVisible.value = false
  selectedHistory.value = null
}

// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
onMounted(() => {
  document.addEventListener('click', closeContextMenu)
})

onUnmounted(() => {
  document.removeEventListener('click', closeContextMenu)
})

// å®šä½åˆ°è¯¥é¡¹
const handleLocate = () => {
  if (!selectedHistory.value) return
  closeContextMenu()
  emit('locate', selectedHistory.value.recordId)
}

// è¿˜åŸä¿®æ”¹
const handleRevert = () => {
  if (!selectedHistory.value || selectedHistory.value.operationType === 'DELETE') return
  
  if (!confirm('ç¡®å®šè¦è¿˜åŸæ­¤ä¿®æ”¹å—ï¼Ÿ')) return
  
  closeContextMenu()
  emit('revert', selectedHistory.value)
}
```

#### 1.3 ä¿®æ”¹å†å²è®°å½•é¡¹æ¨¡æ¿ï¼Œæ·»åŠ å³é”®äº‹ä»¶
```vue
<div
  v-for="(history, index) in editHistoryList"
  :key="index"
  class="history-item"
  :class="{ 'deleted-item': history.operationType === 'DELETE' }"
  @contextmenu.prevent="showContextMenu($event, history)"
>
```

#### 1.4 æ·»åŠ æ ·å¼
```css
/* å³é”®èœå• */
.context-menu {
  position: fixed;
  background: white;
  border: 1px solid var(--theme-border);
  border-radius: var(--theme-border-radius);
  box-shadow: var(--theme-shadow);
  z-index: 1000;
  min-width: 140px;
  padding: 4px 0;
}

.context-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: var(--theme-font-size-sm);
  color: var(--theme-text-primary);
}

.context-menu-item:hover {
  background: rgba(235, 86, 74, 0.1);
}

.context-menu-item.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.context-menu-item.disabled:hover {
  background: transparent;
}

.menu-icon {
  font-size: 14px;
}
```

#### 1.5 ä¿®æ”¹ emits å®šä¹‰
```typescript
interface Emits {
  (e: 'close'): void
  (e: 'locate', recordId: number): void
  (e: 'revert', history: RecordHistory): void
}
```

### æ­¥éª¤2ï¼šä¿®æ”¹ App.vue

#### 2.1 ä¿®æ”¹ EditHistoryModal ç»„ä»¶è°ƒç”¨
```vue
<EditHistoryModal
  v-if="showEditHistoryModal"
  @close="closeEditHistoryModal"
  @locate="handleLocateRecord"
  @revert="handleRevertRecord"
/>
```

#### 2.2 æ·»åŠ å®šä½è®°å½•å¤„ç†æ–¹æ³•
```typescript
// å®šä½åˆ°æŒ‡å®šè®°å½•
const handleLocateRecord = async (recordId: number) => {
  // å…³é—­ä¿®æ”¹è®°å½•å¼¹çª—
  closeEditHistoryModal()
  
  try {
    // æŸ¥æ‰¾è®°å½•æ‰€åœ¨é¡µç 
    const page = await recordsStore.findRecordPage(recordId)
    
    // è®¾ç½®å½“å‰é¡µç 
    currentPage.value = page
    
    // ç­‰å¾…é¡µé¢æ¸²æŸ“å®Œæˆåé«˜äº®è®°å½•
    setTimeout(() => {
      recordListRef.value?.highlightRecord(recordId)
    }, 300)
  } catch (error) {
    console.error('å®šä½è®°å½•å¤±è´¥:', error)
    toastRef.value?.error('å®šä½è®°å½•å¤±è´¥')
  }
}
```

#### 2.3 æ·»åŠ è¿˜åŸè®°å½•å¤„ç†æ–¹æ³•
```typescript
// è¿˜åŸä¿®æ”¹
const handleRevertRecord = async (history: RecordHistory) => {
  // å…³é—­ä¿®æ”¹è®°å½•å¼¹çª—
  closeEditHistoryModal()
  
  try {
    // æ„å»ºè¿˜åŸåçš„è®°å½•æ•°æ®
    const revertedRecord: Record = {
      id: history.recordId,
      guestName: history.guestName || '',
      amount: history.amount || 0,
      amountChinese: history.amountChinese || '',
      itemDescription: history.itemDescription || '',
      paymentType: history.paymentType || 1,
      remark: history.remark || '',
      createTime: history.createTime || new Date().toISOString(),
      updateTime: new Date().toISOString(),
      isDeleted: 0,
    }
    
    // æ›´æ–°è®°å½•
    await recordsStore.updateRecord(revertedRecord)
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    toastRef.value?.success('è¿˜åŸæˆåŠŸï¼', 3000)
    
    // æŸ¥æ‰¾è®°å½•æ‰€åœ¨é¡µç å¹¶è·³è½¬
    const page = await recordsStore.findRecordPage(history.recordId)
    currentPage.value = page
    
    // ç­‰å¾…é¡µé¢æ¸²æŸ“å®Œæˆåé«˜äº®è®°å½•
    setTimeout(() => {
      recordListRef.value?.highlightRecord(history.recordId)
    }, 300)
  } catch (error) {
    console.error('è¿˜åŸä¿®æ”¹å¤±è´¥:', error)
    toastRef.value?.error('è¿˜åŸä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}
```

### æ­¥éª¤3ï¼šä¿®æ”¹ RecordList.vue

#### 3.1 æ·»åŠ é«˜äº®è®°å½•åŠŸèƒ½
```typescript
// é«˜äº®æ˜¾ç¤ºæŒ‡å®šè®°å½•
const highlightedRecordId = ref<number | null>(null)

const highlightRecord = (recordId: number) => {
  highlightedRecordId.value = recordId
  
  // 3ç§’åå–æ¶ˆé«˜äº®
  setTimeout(() => {
    highlightedRecordId.value = null
  }, 3000)
}

// æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
defineExpose({
  goToRecord,
  goToFirstPage,
  goToLastPage,
  highlightRecord,
})
```

#### 3.2 ä¿®æ”¹è®°å½•é¡¹æ¨¡æ¿ï¼Œæ·»åŠ é«˜äº®æ ·å¼
```vue
<div
  v-for="(record, index) in paginatedRecords"
  :key="record.id || index"
  class="record-column"
  :class="{
    'deleted': record.isDeleted,
    'highlighted': record.id === highlightedRecordId
  }"
  @contextmenu.prevent="showContextMenu($event, record)"
>
```

#### 3.3 æ·»åŠ é«˜äº®åŠ¨ç”»æ ·å¼
```css
/* é«˜äº®åŠ¨ç”» */
@keyframes highlight-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(235, 86, 74, 0.7);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(235, 86, 74, 0);
  }
}

.record-column.highlighted {
  animation: highlight-pulse 1s ease-in-out 3;
  border: 2px solid var(--theme-accent);
  z-index: 10;
}
```

## å®ç°é¡ºåº

1. **æ­¥éª¤1** - ä¿®æ”¹ EditHistoryModal.vueï¼ˆæ·»åŠ å³é”®èœå•ï¼‰
2. **æ­¥éª¤3** - ä¿®æ”¹ RecordList.vueï¼ˆæ·»åŠ é«˜äº®åŠŸèƒ½ï¼‰
3. **æ­¥éª¤2** - ä¿®æ”¹ App.vueï¼ˆæ·»åŠ äº‹ä»¶å¤„ç†ï¼‰

## é¢„æœŸæ•ˆæœ

- åœ¨ä¿®æ”¹è®°å½•æŸ¥è¯¢ç•Œé¢å³é”®ç‚¹å‡»è®°å½•ï¼Œå¼¹å‡ºèœå•
- ç‚¹å‡»"å®šä½åˆ°è¯¥é¡¹"ï¼šå…³é—­å¼¹çª—ï¼Œè·³è½¬åˆ°è®°å½•æ‰€åœ¨é¡µï¼Œè®°å½•é«˜äº®é—ªçƒ3ç§’
- ç‚¹å‡»"è¿˜åŸä¿®æ”¹"ï¼šç¡®è®¤åè¿˜åŸæ•°æ®ï¼Œå…³é—­å¼¹çª—ï¼Œè·³è½¬åˆ°è®°å½•æ‰€åœ¨é¡µï¼Œè®°å½•é«˜äº®é—ªçƒ3ç§’
