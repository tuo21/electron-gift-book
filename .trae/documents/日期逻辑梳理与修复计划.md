# 日期逻辑梳理与修复计划

## 一、当前日期逻辑梳理

### 1. 数据库层面

**文件**: `electron/database.ts`

- 记录表 `Records` 包含 `CreateTime` 字段，类型为 `DATETIME`，默认值为 `CURRENT_TIMESTAMP`
- 记录按 `CreateTime ASC, Id ASC` 排序（先输入的在前）
- 每条记录都有独立的 `createTime` 字段，表示该记录的创建时间

```typescript
// 表结构
CREATE TABLE IF NOT EXISTS Records (
  Id INTEGER PRIMARY KEY AUTOINCREMENT,
  GuestName TEXT NOT NULL,
  Amount DECIMAL(10, 2) NOT NULL DEFAULT 0,
  AmountChinese TEXT,
  ItemDescription TEXT,
  PaymentType INTEGER DEFAULT 0,
  Remark TEXT,
  CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 记录创建时间
  UpdateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
  IsDeleted INTEGER DEFAULT 0
)
```

### 2. 导出功能中的日期处理

**文件**: `src/utils/export.ts`

**问题所在**：

```typescript
// 第 16-22 行 - 生成文件名使用当前日期
function generateExportFileName(eventName: string): string {
  const now = new Date()
  const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`
  const cleanName = eventName.replace(/[\\/:*?"<>|]/g, '_')
  return `${cleanName}_${dateStr}`
}

// 第 78-80 行 - PDF 导出使用当前日期
export async function exportToPDF(...) {
  const now = new Date()
  const exportDate = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`  // 导出当天的日期！
  const filename = generateExportFileName(eventName)
  // ...
}
```

**问题分析**：
- `generateExportFileName` 使用 `new Date()` 获取**导出当天**的日期
- `exportToPDF` 中的 `exportDate` 也是使用 `new Date()` 获取**导出当天**的日期
- 这导致无论何时创建的事务，导出时显示的都是导出当天的日期

### 3. 数据流分析

```
用户创建事务/记录
    ↓
数据库自动设置 CreateTime = CURRENT_TIMESTAMP（记录创建时间）
    ↓
用户导出数据
    ↓
export.ts 使用 new Date() 获取导出当天日期 ← 问题！应该是事务创建日期
    ↓
PDF/Excel 显示导出当天日期
```

## 二、问题总结

### 当前问题
1. **导出日期不正确**：导出时显示的日期是导出当天的日期，而不是事务创建的日期
2. **文件名日期不正确**：文件名中的日期也是导出当天的日期
3. **用户体验问题**：用户希望导出文件显示的是事务发生的日期，而不是导出操作的日期

### 期望行为
- 导出日期应该显示**事务创建日期**（即第一条记录的创建日期，或事务创建时的日期）
- 文件名中的日期也应该是**事务创建日期**

## 三、解决方案

### 方案概述
通过分析记录数据，获取最早一条记录的创建时间作为事务日期，用于导出显示。

### 具体修改计划

#### 1. 修改 `src/utils/export.ts`

**修改 `generateExportFileName` 函数**：
- 添加可选参数 `eventDate`，用于指定日期
- 如果没有提供 `eventDate`，则使用当前日期（保持向后兼容）

**修改 `exportToExcel` 函数**：
- 从记录列表中提取最早的创建日期作为事务日期
- 使用事务日期生成文件名

**修改 `exportToPDF` 函数**：
- 从记录列表中提取最早的创建日期作为事务日期
- 使用事务日期作为 `exportDate` 和文件名

**实现逻辑**：
```typescript
/**
 * 从事记录列表中获取事务日期（最早的记录创建时间）
 * @param records 记录列表
 * @returns 格式化后的日期字符串（YYYY年MM月DD日）
 */
function getEventDate(records: Record[]): string {
  if (records.length === 0) {
    const now = new Date()
    return `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`
  }
  
  // 找到最早的创建时间
  const earliestRecord = records.reduce((earliest, record) => {
    if (!record.createTime) return earliest
    if (!earliest.createTime) return record
    return new Date(record.createTime) < new Date(earliest.createTime) ? record : earliest
  })
  
  if (!earliestRecord.createTime) {
    const now = new Date()
    return `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`
  }
  
  const date = new Date(earliestRecord.createTime)
  return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`
}

/**
 * 生成导出文件名
 * @param eventName 事务名称
 * @param eventDate 事务日期（可选，默认为当前日期）
 * @returns 文件名（不含扩展名）
 */
function generateExportFileName(eventName: string, eventDate?: Date): string {
  let dateStr: string
  if (eventDate) {
    dateStr = `${eventDate.getFullYear()}${String(eventDate.getMonth() + 1).padStart(2, '0')}${String(eventDate.getDate()).padStart(2, '0')}`
  } else {
    const now = new Date()
    dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`
  }
  const cleanName = eventName.replace(/[\\/:*?"<>|]/g, '_')
  return `${cleanName}_${dateStr}`
}
```

#### 2. 修改 `src/services/exportService.ts`

**修改 `exportRecordsToExcel` 和 `exportRecordsToPDF` 函数**：
- 从记录中提取事务日期
- 传递给底层的导出函数

**修改 `exportStatisticsReport` 和 `exportEditHistory` 函数**：
- 同样使用事务日期而非当前日期

### 修改文件清单

1. `src/utils/export.ts` - 核心导出函数
2. `src/services/exportService.ts` - 导出服务层

### 向后兼容性
- 如果没有记录或记录没有创建时间，则回退到使用当前日期
- 保持函数签名兼容，添加可选参数

## 四、实施步骤

1. **修改 `src/utils/export.ts`**
   - 添加 `getEventDate` 辅助函数
   - 修改 `generateExportFileName` 函数，支持传入日期
   - 修改 `exportToExcel` 函数，使用记录中的最早日期
   - 修改 `exportToPDF` 函数，使用记录中的最早日期

2. **修改 `src/services/exportService.ts`**
   - 更新导出函数以支持事务日期

3. **测试验证**
   - 创建新事务并添加记录
   - 等待一天后导出，验证导出日期是否为记录创建日期而非导出日期
   - 测试空记录情况
   - 测试单条记录情况
   - 测试多条记录情况

## 五、预期效果

- 导出 PDF/Excel 时，显示的日期将是事务中最早一条记录的创建日期
- 文件名中的日期也将是事务日期
- 用户可以在任何时间导出，都能看到正确的事务日期
 